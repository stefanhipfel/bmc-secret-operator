# Claude Development Guide

This file contains important context and guidelines for AI assistants working on the BMC Secret Operator project.

## Project Overview

The BMC Secret Operator is a Kubernetes operator written in Go that synchronizes BMC (Baseboard Management Controller) credentials to secret backends like HashiCorp Vault or OpenBao. It watches for BMCSecret custom resources, discovers associated BMC resources, extracts credentials, and syncs them to the configured backend.

## Required Checks After Every Change

**CRITICAL**: After making any code changes, ALWAYS run the following commands to verify the changes:

```bash
# 1. Build the project
make build

# 2. Run all tests
make test

# 3. Run linter
golangci-lint run ./...

# 4. Format code
gofmt -w .
```

If any of these fail, fix the issues before proceeding.

## Project Structure

```
.
├── api/v1alpha1/              # CRD definitions (BMCSecret, SecretBackendConfig, etc.)
├── cmd/main.go                # Entry point - manager initialization
├── config/                    # Kustomize manifests for deployment
│   ├── crd/                   # CustomResourceDefinitions
│   ├── manager/               # Deployment configuration
│   ├── rbac/                  # RBAC roles and bindings
│   └── samples/               # Example resources
├── dist/chart/                # Helm chart (generated by Kubebuilder)
├── internal/
│   ├── controller/            # Reconciler implementations
│   │   ├── bmcsecret_controller.go
│   │   ├── secretbackendconfig_controller.go
│   │   └── bmcresolver/       # BMC discovery logic
│   ├── metrics/               # Prometheus metrics package
│   │   ├── metrics.go         # Metrics definitions and collector
│   │   └── backend_wrapper.go # Backend instrumentation decorator
│   └── secretbackend/         # Backend interface and implementations
│       ├── factory.go         # Backend factory with config loading
│       ├── vault/             # Vault/OpenBao backend implementation
│       └── config.go          # Configuration types
├── test/
│   ├── e2e/                   # End-to-end tests (run in Kind cluster)
│   └── utils/                 # Test utilities
└── docs/                      # Documentation
    ├── metrics.md             # Metrics documentation
    └── testing-metrics.md     # Metrics testing guide
```

## Key Architecture Patterns

### 1. Controller Pattern
- **BMCSecretReconciler**: Main controller that reconciles BMCSecret resources
  - Discovers BMCs via label selectors
  - Extracts credentials from referenced secrets
  - Syncs to backend using configured path templates
  - Updates status with sync results

- **SecretBackendConfigReconciler**: Watches SecretBackendConfig changes
  - Invalidates backend factory cache when config changes
  - Allows dynamic configuration updates

### 2. Backend Abstraction
- `Backend` interface provides abstraction over Vault/OpenBao
- `BackendFactory` creates backends based on configuration
- Configuration sources (priority order):
  1. SecretBackendConfig CRD (if exists)
  2. Environment variables (fallback)
- Backends support: Write, Read, Delete operations

### 2a. Multi-Engine Secret Backends
- **SecretEngineConfig** array in VaultConfig enables routing secrets to multiple Vault engines
- Each engine can have:
  - Unique mount path (KV engine mount location)
  - Custom path template for secret naming
  - Label-based sync filter (exact "key=value" or any-value "key" matching)
- Global syncLabel acts as additional filter (AND logic with engine syncLabel)
- **EngineBackend** struct wraps Backend with per-engine configuration
- Error isolation: One engine failure doesn't affect other engines
- Backward compatible: Empty SecretEngines list uses single default backend

### 3. Metrics Instrumentation
- **Singleton pattern** for metrics collector (prevents duplicate registration panics)
- **Decorator pattern** for backend instrumentation (transparent metrics collection)
- All controller operations are timed and counted
- Metrics cover: reconciliation, backend ops, auth, discovery, sync status

## Common Development Tasks

### Adding New Fields to CRDs

1. Update the API types in `api/v1alpha1/`
2. Run `make generate` to update generated code
3. Run `make manifests` to update CRD YAML files
4. Update controller logic to handle new fields
5. Add tests for the new functionality
6. Run verification commands (build, test, lint)

### Adding New Metrics

1. Define metric in `internal/metrics/metrics.go` NewCollector()
2. Add recording method to Collector struct
3. Add tests in `internal/metrics/metrics_test.go`
4. Instrument controllers/backends to record the metric
5. Update `docs/metrics.md` with the new metric
6. Run verification commands

### Modifying Controllers

1. Update reconciliation logic in `internal/controller/`
2. Ensure all metrics calls check `if r.Metrics != nil`
3. Update tests in corresponding `*_test.go` files
4. Run `make test` to verify
5. Check for linter issues with `golangci-lint run ./...`

### Updating Dependencies

```bash
go get <package>@<version>
go mod tidy
make test
```

## Linting Standards

The project uses `golangci-lint` with strict rules:

- **Line length**: Max 120 characters
- **Error checking**: All errors must be checked (errcheck)
- **Constants**: Repeated strings (3+) should be constants (goconst)
- **Modernization**: Use `any` instead of `interface{}` (modernize)
- **Preallocation**: Pre-allocate slices when size is known (prealloc)
- **Revive**: No import shadowing, proper naming conventions
- **Staticcheck**: Follow deprecation warnings

### Common Linter Fixes

```go
// ❌ Bad: Unchecked error
defer file.Close()

// ✅ Good: Checked error
defer func() {
    if err := file.Close(); err != nil {
        log.Error(err, "failed to close file")
    }
}()

// ❌ Bad: Repeated string
result := "success"
if err != nil {
    result = "error"
}

// ✅ Good: Use constant
const (
    resultSuccess = "success"
    resultError   = "error"
)

// ❌ Bad: interface{}
func process(data map[string]interface{}) error

// ✅ Good: any
func process(data map[string]any) error

// ❌ Bad: Import shadowing
logger := log.FromContext(ctx)
log := logger.WithValues("key", "value")  // shadows import

// ✅ Good: Use different name
logger := log.FromContext(ctx)
contextLogger := logger.WithValues("key", "value")
```

## Testing

### Unit Tests
```bash
make test
```

### E2E Tests
```bash
# Requires Kind cluster
make test-e2e
```

E2E tests:
- Build controller image
- Load into Kind cluster
- Deploy with kustomize
- Verify pod becomes ready
- Test metrics endpoint
- Validate controller functionality

### Metrics Testing
```bash
# Run locally
make run

# In another terminal, check metrics
curl http://localhost:8080/metrics | grep bmcsecret_
```

### Multi-Engine Testing
The test infrastructure for multi-engine support includes:
- **MockMultiEngineBackendFactory**: Mock factory supporting multiple engines
- **Test cases** covering:
  - Label matching (exact "key=value" vs any-value "key")
  - Global + engine syncLabel filtering
  - Per-engine path templates and mount paths
  - Error isolation between engines
  - Backward compatibility with empty SecretEngines

To test multi-engine functionality:
```bash
# Run all tests (includes multi-engine tests)
make test

# Check test output for multi-engine test cases
go test ./internal/controller -v -run "MultiEngine"
```

## Helm Chart

The Helm chart is generated using Kubebuilder's helm/v2-alpha plugin:

```bash
# Regenerate chart from kustomize
kubebuilder edit --plugins=helm.kubebuilder.io/v2-alpha

# Test chart
helm lint ./dist/chart
helm template test ./dist/chart
```

Chart features:
- Conditional CRD installation (`crd.enable`)
- Conditional RBAC helpers (`rbacHelpers.enable`)
- Prometheus ServiceMonitor (`prometheus.enable`)
- Cert-manager integration (`certManager.enable`)
- Configurable backend via environment variables or SecretBackendConfig CRD

## Important Implementation Notes

### Event Recording
The project uses the **old** events API (`record.EventRecorder`) with nolint directives:
```go
//nolint:staticcheck // TODO: migrate to new events API
Recorder: mgr.GetEventRecorderFor("controller-name")
```

Do NOT migrate to `mgr.GetEventRecorder()` without a complete refactor - the interfaces are incompatible.

### Metrics Singleton
The metrics collector MUST use singleton pattern to prevent duplicate registration panics:
```go
var (
    once     sync.Once
    instance *Collector
)

func NewCollector() *Collector {
    once.Do(func() {
        instance = &Collector{ /* ... */ }
    })
    return instance
}
```

### Nil Checks
Always check if optional dependencies are nil before using:
```go
if r.Metrics != nil {
    r.Metrics.RecordSomething(...)
}
```

### Backend Cleanup
Backend factory must be closed on shutdown:
```go
defer func() {
    if err := backendFactory.Close(); err != nil {
        setupLog.Error(err, "failed to close backend factory")
    }
}()
```

### Multi-Engine Label Matching
Label sync format in SecretEngineConfig:
- **"key=value"**: Exact match - only syncs if label key=value matches exactly
- **"key"**: Any value match - syncs if label key exists with any value
- **Global syncLabel**: Acts as additional AND filter (must match if configured)

Example:
```yaml
SecretEngineConfig:
- name: team-a
  syncLabel: "team=a"              # Exact match: team must equal "a"
- name: non-prod
  syncLabel: "env"                 # Any value: env label must exist

# Global filter (if configured)
spec.syncLabel: "sync-enabled"     # BMCSecret must have sync-enabled label
```

## CI/CD

GitHub Actions workflows:
- **lint.yml**: Runs golangci-lint
- **test.yml**: Runs unit tests
- **test-e2e.yml**: Runs E2E tests in Kind cluster
- **test-chart.yml**: Tests Helm chart

All must pass before merging PRs.

## Debugging Tips

### Controller Not Starting
```bash
# Check pod status
kubectl get pods -n bmc-secret-operator-system

# Check logs
kubectl logs -n bmc-secret-operator-system -l control-plane=controller-manager

# Check events
kubectl get events -n bmc-secret-operator-system --sort-by=.lastTimestamp
```

### Metrics Not Working
```bash
# Port-forward to metrics endpoint
kubectl port-forward -n bmc-secret-operator-system svc/bmc-secret-operator-controller-manager-metrics-service 8443:8443

# Test metrics (with TLS)
curl -k https://localhost:8443/metrics

# Check if metrics server started
kubectl logs -n bmc-secret-operator-system -l control-plane=controller-manager | grep "Serving metrics"
```

### Backend Connection Issues
```bash
# Check SecretBackendConfig
kubectl get secretbackendconfig -o yaml

# Check operator logs for backend errors
kubectl logs -n bmc-secret-operator-system -l control-plane=controller-manager | grep -i "backend\|vault"
```

## Code Style

- Use meaningful variable names, avoid single letters except for standard cases (i, j, k, err)
- Keep functions focused and under 50 lines when possible
- Add comments for complex logic, not obvious code
- Follow Go conventions: receiver names should be first letter of type
- Use early returns to reduce nesting
- Log at appropriate levels: Info for normal operations, Error for failures

## References

- [Controller Runtime Docs](https://pkg.go.dev/sigs.k8s.io/controller-runtime)
- [Kubebuilder Book](https://book.kubebuilder.io/)
- [Prometheus Client Go](https://pkg.go.dev/github.com/prometheus/client_golang/prometheus)
- [Operator Best Practices](https://sdk.operatorframework.io/docs/best-practices/)

## Quick Commands Reference

```bash
# Development
make run                 # Run locally against configured cluster
make build              # Build manager binary
make docker-build       # Build container image
make deploy             # Deploy to cluster using kustomize

# Testing
make test               # Run unit tests
make test-e2e          # Run E2E tests (requires Kind)
golangci-lint run ./...  # Run linter

# Code Generation
make generate           # Generate code (DeepCopy, etc.)
make manifests         # Generate CRDs and RBAC

# Helm
helm lint ./dist/chart                    # Lint chart
helm template test ./dist/chart           # Render templates
helm install bmc-secret-operator ./dist/chart  # Install
```

## Before Committing

**Checklist**:
- [ ] Code builds: `make build`
- [ ] Tests pass: `make test`
- [ ] Linter passes: `golangci-lint run ./...`
- [ ] Code formatted: `gofmt -w .`
- [ ] CRDs updated (if API changed): `make manifests`
- [ ] Generated code updated (if API changed): `make generate`
- [ ] Documentation updated (if user-facing changes)
- [ ] Helm chart regenerated (if manifests changed): `kubebuilder edit --plugins=helm.kubebuilder.io/v2-alpha`

## Common Pitfalls

1. **Forgetting nil checks for metrics**: Always check `if r.Metrics != nil`
2. **Not checking errors**: Linter will fail on unchecked errors, especially in defer statements
3. **Using interface{} instead of any**: Use `any` for Go 1.18+
4. **Import shadowing**: Don't reuse import names as variables (e.g., `log := ...` shadows the log package)
5. **Line length**: Keep lines under 120 characters
6. **Duplicate metric registration**: Metrics collector is now singleton - don't create custom instances
7. **Event recorder deprecation**: Use `GetEventRecorderFor` with nolint, not `GetEventRecorder`

## Getting Help

- GitHub Issues: https://github.com/ironcore-dev/bmc-secret-operator/issues
- Documentation: See `docs/` directory
- Helm Chart: See `dist/chart/README.md`
